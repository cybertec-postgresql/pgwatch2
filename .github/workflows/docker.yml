name: Update Docker
on: 
  push:
    # paths:
    #   - '**.go'
    #   - '**.yaml'
    #   - '**.yml'
    #   - 'go.mod'
    #   - 'go.sum'
    #   - 'Dockerfile'  
    branches:
      - '*'
    tags:
      - v[0-9]+.[0-9]+.[0-9]+*      
  workflow_dispatch:

jobs:
  docker:
    if: true # false to skip job during debug
    runs-on: ubuntu-latest
    steps:

    - name: Check out code
      uses: actions/checkout@v2

    - id: vartest
      run: |
        echo "$GITHUB_REF_NAME of type $GITHUB_REF_TYPE at commit ${GITHUB_SHA::6}"
        echo ::save-state name=RELEASE_VERSION::$(echo $GITHUB_REF_NAME_${GITHUB_SHA:6})
        echo ::save-state name=RELEASE_TIME::$(git show -s --format=%cI HEAD)
    # - name: Set up Golang
    #   uses: actions/setup-go@v2
    #   with:
    #     go-version: '1.16'

    # # despite the fact docker will build binary internally 
    # # we want to stop workflow in case of any error before pushing to registry 
    # - name: Get dependencies and Build
    #   run: |GIT_TIME
    #     go version
    #     go mod download
    #     go build

    - name: Publish to Registry
      uses: elgohr/Publish-Docker-Github-Action@master
      with:
        name: cybertec/pgwatch2-postgres
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
        dockerfile: docker/Dockerfile-postgres
        buildoptions: "--build-arg GIT_TIME=${{ env.STATE_RELEASE_VERSION }} --build-arg GIT_HASH=${{ env.STATE_RELEASE_TIME }}"
        tags: "gha_test"
        tag_semver: true
